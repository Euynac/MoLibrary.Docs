# MoTaskScheduler

## 概念

任务仅分为两种任务定义类型：定时任务以及触发式任务。开发者创建任务必须先定义继承自这两种基础任务定义类型的任务类，任务定义构造函数支持依赖注入。
任务执行请求实例由调度器通过任务定义来创建。

### RecurringTask 定时任务
- 定时任务根据定义的周期进行执行，如果周期未定义，则永远不会自动执行。
- 周期可以在面板进行修改，根据 `Crontab` 表达式语法来定义周期。

### TriggeredTask 触发式任务

- 触发式任务与定时任务不同的是它可以传入动态的任务参数（参数需支持Json序列化）
- 一般通过代码触发，也可在面板或通过接口触发。
- 支持提交调度器进行延时触发

### TaskOptions

任务配置含有全局配置以及对特定任务通过特性标签进行配置，优先级全局配置低于特性标签。
以下配置会在作业首次加入到调度器注册到元数据持久层，未特殊说明均可进行动态编辑并保存到持久层，后续启动调度器以持久层配置为准。

#### 通用配置

>两种任务都支持的配置项

- **最大并发数量**：相同任务Key的并发执行数量。默认值为`1`，如果超过并发数量，新的任务执行请求将被`Skipped`
- **任务名**：可理解的任务名称，默认值为 `TypeName`
- **重试次数**：默认值为`0`，任务出现异常后立即自动进行重试，会被最大并发数量影响。
- **任务最大执行超时时间**：当任务超过此时间仍未返回结果，则任务视为执行超时失败，Worker执行器会将`CancellationToken`置为以已取消状态来尝试终止该任务（如果任务没有使用取消令牌机制，则该线程将一直被占用，由于`.NET`机制，无法强制杀死后台进程）。默认值为 `1小时`。
- **是否禁用**：是否禁用该任务
- **任务唯一标识符**（无法修改）：用于区分任务定义，需要在整个元数据持久层唯一标志出作业定义，默认值为`TypeFullName`。
- **任务描述**：描述任务业务作用。

#### 定时任务配置
- **定时任务表达式**：`Crontab`表达式语法，支持到秒级。
- **任务结束时间**：任务结束时间，如果为 `null` 表示任务永不结束
- **任务开始时间**：任务只会在此时间之后执行

### WorkerOptions

>作业执行平面的设置

- **最大作业执行线程数量**：同时执行的任务数量，超过此线程数量则被阻塞，不会立即消费任务执行。默认值为`null`，即不会对执行数量进行限制，收到调度器执行请求后立即创建线程进行执行。

### SchedulerOptions

> 控制平面的调度器设置

- **启用定时任务调试模式**：调试模式下所有定时任务都不会自动执行，只能手动在`UI`层触发。
- **启用触发式任务调试模式**：调试模式下所有触发式任务都不会自动执行，只能手动在`UI`层触发。


### TaskState
任务执行请求实例状态

1. **Enqueued**：任务已加入队列，等待处理
2. **Processing**：任务正在执行
3. **Succeeded**：任务成功完成
4. **Failed**：任务执行失败
5. **Scheduled**：延迟任务，等待到达执行时间
6. **Terminated**：任务达到重试上限被终止（也代表任务失败）
7. **Cancelled**：任务被人工或各种原因取消
8. **Skipped**：任务由于并发数量上限冲突被忽略执行



## 架构

中心化管理，去中心化执行。
Worker执行平面需要与控制平面设置同一个元数据持久层，执行平面直接修改任务实例信息。

### Control Plane 控制平面

#### 接口定义

##### Work侧
- 任务注册检测
用于Worker批量传入任务唯一标识符，返回有哪些未注册的任务，使用任务注册接口注册。

- 任务注册
批量传入任务定义模型，注册到元数据持久层。

##### UI层
通用：
- 获取所有任务列表
- 创建任务实例
- 查看任务历史
- 取消任务实例执行

定时任务特有：
- 暂停定时任务
- 继续定时任务
- 修改定时任务配置

触发式任务特有：
- 修改触发式任务配置



### Worker 执行平面

#### 接口定义
##### UI

> 与控制平面侧功能相同，但范围需局限在Work服务相关的任务


### Metadata Store 元数据持久层

提供 `IMoTaskScheduleMetadataStore` 抽象，提供默认 `MetadataStoreInMemoryProvider` 实现。


### Message Broker 任务分发层

使用 `IMoEventBus` 作为消息中间件，实现交于该模块管理。